<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trip Fit Weather</title>
  <meta name="description" content="여행 기간별 날씨 예보와 성별/연령대 맞춤 코디, 패킹리스트를 한 번에 추천합니다." />
  <style>
    :root{
      --bg:#f6f8fb;--card:#ffffff;--line:#e7ecf5;--text:#101828;--muted:#667085;
      --pri:#6d5efc;--pri2:#49c7ff;--chip:#f2f5ff;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color:var(--text); background:var(--bg)}
    .wrap{max-width:1120px;margin:0 auto;padding:24px}

    .hero{background:linear-gradient(120deg,#6d5efc 0%,#8f74ff 45%,#49c7ff 100%);color:#fff;border-radius:28px;padding:28px 26px;box-shadow:0 18px 40px rgba(41,57,155,.22)}
    .hero h1{margin:0;font-size:42px;line-height:1.05;font-weight:800;letter-spacing:-.5px}
    .hero p{margin:12px 0 0;opacity:.95;max-width:820px}
    .hero .chip{display:inline-flex;align-items:center;background:rgba(255,255,255,.16);border:1px solid rgba(255,255,255,.28);padding:6px 12px;border-radius:999px;font-size:12px;font-weight:700;margin-bottom:10px}

    .searchCard{margin-top:-28px;background:var(--card);border:1px solid var(--line);border-radius:20px;padding:16px;box-shadow:0 12px 30px rgba(16,24,40,.08)}
    .grid{display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr 1fr;gap:10px}
    input,select,button{height:44px;border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--text);padding:0 12px;font-size:14px}
    input:focus,select:focus{outline:none;border-color:#b8c5ff;box-shadow:0 0 0 3px rgba(109,94,252,.15)}
    button{border:none;background:linear-gradient(120deg,var(--pri),var(--pri2));color:#fff;font-weight:800;cursor:pointer}
    .subrow{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px;color:var(--muted);font-size:13px}

    .section{margin-top:14px;background:var(--card);border:1px solid var(--line);border-radius:18px;padding:16px}
    .title{font-size:14px;font-weight:800;color:#344054;margin-bottom:10px}
    .summaryTop{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .kpi{display:flex;gap:8px;flex-wrap:wrap}
    .badge{display:inline-flex;padding:6px 10px;background:var(--chip);border:1px solid #dbe3ff;border-radius:999px;color:#3f4f8a;font-size:12px;font-weight:700}

    .layout{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}

    .daysGrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .dayCard{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff}
    .dayMeta{font-size:13px;color:var(--muted)}
    .dayCard img{width:100%;border-radius:10px;margin-top:8px;border:1px solid var(--line);aspect-ratio:3/4;object-fit:cover}

    .ok{color:#16a34a}.err{color:#d92d20}.muted{color:var(--muted)}

    @media (max-width:1024px){
      .grid{grid-template-columns:1fr 1fr 1fr}
    }
    @media (max-width:760px){
      .hero h1{font-size:32px}
      .layout{grid-template-columns:1fr}
      .daysGrid{grid-template-columns:1fr}
      .grid{grid-template-columns:1fr}
      .searchCard{margin-top:12px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="hero">
      <div class="chip">✨ DailyDressMe 느낌 · 여행 코디 AI</div>
      <h1>Trip Fit Weather</h1>
      <p>여행 도시/기간을 입력하면 날짜별 날씨와 코디를 이미지와 함께 추천해드립니다. 비·더위·일교차까지 반영해서 패킹리스트도 자동으로 제공합니다.</p>
    </section>

    <section class="searchCard">
      <div class="grid">
        <input id="city" placeholder="도시 (예: Bangkok, New York, Seoul)" value="Bangkok" />
        <input id="country" placeholder="국가코드 (예: TH, US, KR)" value="TH" />
        <select id="gender"><option>남성</option><option>여성</option><option>중립</option></select>
        <select id="age"><option>10대</option><option selected>20대</option><option>30대</option><option>40대</option><option>50대</option><option>60대</option><option>70대</option></select>
        <input id="start" type="date" />
        <input id="end" type="date" />
      </div>
      <div class="subrow">
        <button id="runBtn">추천 받기</button>
        <span id="status">대기중</span>
        <span>예보 범위를 넘는 날짜는 기후 평균 fallback으로 계산됩니다.</span>
      </div>
    </section>

    <div class="layout">
      <section id="summary" class="section">결과가 여기에 표시됩니다.</section>
      <section id="packing" class="section"><div class="title">패킹리스트</div><div class="muted">여행 조건 입력 후 생성됩니다.</div></section>
    </div>

    <section id="days" class="section">
      <div class="title">날짜별 코디</div>
      <div class="muted">추천을 실행하면 날짜별 카드가 표시됩니다.</div>
    </section>
  </div>

<script>
const $ = (id)=>document.getElementById(id);
const WORKER_API_BASE = 'https://weather-outfit-api.awwzooofficial.workers.dev';
const IMAGE_MODEL = 'qwen/qwen-image';

function fmtDate(d){ return d.toISOString().slice(0,10); }
function addDays(date,n){ const d=new Date(date); d.setDate(d.getDate()+n); return d; }
function dateRange(start,end){ const out=[]; let d=new Date(start); while(d<=end){ out.push(new Date(d)); d=addDays(d,1);} return out; }
function monthDay(s){ return s.slice(5,10); }

function stockOutfitImage(meta){
  const hot = meta.tmax >= 28;
  const warm = meta.tmax >= 20 && meta.tmax < 28;
  const rainy = meta.rainProb >= 50;
  const female = meta.gender === '여성';
  if (rainy && female) return 'https://images.unsplash.com/photo-1515886657613-9f3515b0c78f?auto=format&fit=crop&w=900&q=80';
  if (rainy && !female) return 'https://images.unsplash.com/photo-1521572267360-ee0c2909d518?auto=format&fit=crop&w=900&q=80';
  if (hot && female) return 'https://images.unsplash.com/photo-1529139574466-a303027c1d8b?auto=format&fit=crop&w=900&q=80';
  if (hot && !female) return 'https://images.unsplash.com/photo-1503342217505-b0a15ec3261c?auto=format&fit=crop&w=900&q=80';
  if (warm && female) return 'https://images.unsplash.com/photo-1483985988355-763728e1935b?auto=format&fit=crop&w=900&q=80';
  if (warm && !female) return 'https://images.unsplash.com/photo-1490578474895-699cd4e2cf59?auto=format&fit=crop&w=900&q=80';
  if (female) return 'https://images.unsplash.com/photo-1541101767792-f9b2b1c4f127?auto=format&fit=crop&w=900&q=80';
  return 'https://images.unsplash.com/photo-1519085360753-af0119f7cbe7?auto=format&fit=crop&w=900&q=80';
}

function outfitRule(tMax,tMin,rainProb,gender,age){
  const avg=(tMax+tMin)/2;
  let top='긴팔', bottom='긴바지', outer='가벼운 아우터';
  if(avg>=30){ top='통풍 반팔'; bottom='반바지/얇은 바지'; outer='없음'; }
  else if(avg>=25){ top='반팔'; bottom='얇은 긴바지'; outer='얇은 가디건(실내)'; }
  else if(avg>=20){ top='긴팔/셔츠'; bottom='긴바지'; outer='얇은 자켓'; }
  else if(avg>=14){ top='긴팔+이너'; bottom='긴바지'; outer='자켓'; }
  else { top='니트/후디'; bottom='두께감 바지'; outer='코트/패딩'; }

  const acc=[];
  if(rainProb>=50) acc.push('우산');
  if(tMax>=30) acc.push('모자/선글라스');
  if(tMin<=10) acc.push('보온 머플러');
  acc.push('편한 운동화');

  let fit='활동성 우선';
  if(['10대','20대'].includes(age)) fit='활동성 + 트렌디';
  else if(['50대','60대','70대'].includes(age)) fit='편안함 + 체온유지';

  let g='중립 스타일';
  if(gender==='남성') g='남성 실루엣 기준';
  else if(gender==='여성') g='여성 실루엣 기준';
  return {top,bottom,outer,acc,fit,g};
}

async function geocode(city,country){
  const q = encodeURIComponent(city);
  const c = (country||'').trim().toUpperCase();
  const cc = c ? `&countryCode=${encodeURIComponent(c)}` : '';
  const url=`https://geocoding-api.open-meteo.com/v1/search?name=${q}${cc}&count=10&language=ko&format=json`;
  const r=await fetch(url); if(!r.ok) throw new Error('도시 검색 실패');
  const j=await r.json();
  if(!j.results || !j.results.length) throw new Error('도시를 찾지 못했습니다');
  return j.results[0];
}

async function forecast(lat,lon,start,end){
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`+
    `&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max,precipitation_sum`+
    `&timezone=auto&start_date=${start}&end_date=${end}`;
  const r=await fetch(url); if(!r.ok) throw new Error('예보 조회 실패');
  return r.json();
}

async function historicalFallback(lat,lon,start,end){
  const s=new Date(start), e=new Date(end);
  const ys=s.getFullYear()-5, ye=e.getFullYear()-1;
  const url=`https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}`+
    `&start_date=${ys}-01-01&end_date=${ye}-12-31`+
    `&daily=temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=auto`;
  const r=await fetch(url); if(!r.ok) throw new Error('기후 fallback 조회 실패');
  const j=await r.json();
  const map={};
  const t=j.daily.time||[];
  for(let i=0;i<t.length;i++){
    const md=monthDay(t[i]);
    if(!map[md]) map[md]={n:0,max:0,min:0,pr:0};
    map[md].n++;
    map[md].max += (j.daily.temperature_2m_max?.[i] ?? 0);
    map[md].min += (j.daily.temperature_2m_min?.[i] ?? 0);
    map[md].pr  += (j.daily.precipitation_sum?.[i] ?? 0);
  }
  return map;
}

async function generateOutfitImage(prompt, meta){
  try {
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), 5000);
    const r = await fetch(`${WORKER_API_BASE}/api/generate-outfit-image`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ prompt, model: IMAGE_MODEL }), signal: ctrl.signal
    });
    clearTimeout(t);
    const j = await r.json();
    const b64 = j?.data?.[0]?.b64_json;
    const url = j?.data?.[0]?.url;
    if (b64) return `data:image/png;base64,${b64}`;
    if (url) return url;
  } catch (_) {}
  return stockOutfitImage(meta);
}

function render(summaryHtml, daysHtml, packingHtml){
  $('summary').innerHTML = summaryHtml;
  $('days').innerHTML = `<div class="title">날짜별 코디</div><div class="daysGrid">${daysHtml}</div>`;
  $('packing').innerHTML = `<div class="title">패킹리스트</div>${packingHtml}`;
}

async function run(){
  try{
    $('status').textContent='조회중...';
    const city=$('city').value.trim();
    const country=$('country').value.trim();
    const gender=$('gender').value;
    const age=$('age').value;
    const start=$('start').value; const end=$('end').value;
    if(!city||!start||!end) throw new Error('도시/기간을 입력해 주세요.');
    if(start>end) throw new Error('종료일이 시작일보다 빠릅니다.');

    const loc=await geocode(city,country);
    const today=fmtDate(new Date());
    const maxForecastDate=fmtDate(addDays(new Date(),15));
    const tripDates=dateRange(new Date(start),new Date(end)).map(fmtDate);

    const needFallback = tripDates.some(d=>d>maxForecastDate);
    const forecastEnd = tripDates.filter(d=>d<=maxForecastDate).slice(-1)[0] || today;

    let fData={daily:{time:[],temperature_2m_max:[],temperature_2m_min:[],precipitation_probability_max:[],precipitation_sum:[]}};
    if(start<=forecastEnd){ fData=await forecast(loc.latitude,loc.longitude,start,forecastEnd); }
    const fMap={};
    (fData.daily.time||[]).forEach((d,i)=>{
      fMap[d]={source:'forecast',tmax:fData.daily.temperature_2m_max?.[i],tmin:fData.daily.temperature_2m_min?.[i],rainProb:fData.daily.precipitation_probability_max?.[i] ?? 0,rainMm:fData.daily.precipitation_sum?.[i] ?? 0};
    });

    let climate=null;
    if(needFallback){ climate=await historicalFallback(loc.latitude,loc.longitude,start,end); }

    const rows=[]; const pack=new Set();
    for(const d of tripDates){
      let it=fMap[d];
      if(!it){
        const md=monthDay(d); const c=climate?.[md];
        if(c && c.n>0){ it={source:'climate',tmax:c.max/c.n,tmin:c.min/c.n,rainProb:Math.min(100,Math.round((c.pr/c.n)*20)),rainMm:c.pr/c.n}; }
        else { it={source:'climate',tmax:24,tmin:18,rainProb:30,rainMm:1}; }
      }
      const rec=outfitRule(it.tmax,it.tmin,it.rainProb,gender,age);
      rec.acc.forEach(x=>pack.add(x));
      rows.push({date:d,...it,rec});
    }

    const summaryHtml = `
      <div class="summaryTop"><div><b>${loc.name}</b>, ${loc.country} <span class="muted">(${loc.latitude.toFixed(2)}, ${loc.longitude.toFixed(2)})</span><br><span class="muted">${start} ~ ${end} · ${gender} / ${age}</span></div>
      <div class="kpi"><span class="badge">예보 ${rows.filter(r=>r.source==='forecast').length}일</span><span class="badge">fallback ${rows.filter(r=>r.source==='climate').length}일</span></div></div>`;

    const daysHtml = await Promise.all(rows.map(async (r)=>{
      const prompt = `K-fashion travel outfit photo, exactly one person, ${gender}, ${age}, full body from head to shoes, standing pose, realistic photography, clean background. Weather context: city=${city}, country=${country}, low=${r.tmin.toFixed(1)}C, high=${r.tmax.toFixed(1)}C, rain=${Math.round(r.rainProb)}%. Required clothes: ${r.rec.top}, ${r.rec.bottom}, ${r.rec.outer}. Avoid: text, logo, watermark, extra people, extra limbs, blur, cartoon.`;
      const src = await generateOutfitImage(prompt, {tmax:r.tmax,rainProb:r.rainProb,gender});
      return `<div class="dayCard">
        <div><b>${r.date}</b> <span class="badge">${r.source==='forecast'?'실시간 예보':'기후 평균'}</span></div>
        <div class="dayMeta">${r.tmin.toFixed(1)}°C ~ ${r.tmax.toFixed(1)}°C · 강수 ${Math.round(r.rainProb)}%</div>
        <div style="margin-top:6px"><b>${r.rec.top}</b> + <b>${r.rec.bottom}</b> + <b>${r.rec.outer}</b></div>
        <div class="muted" style="margin-top:4px">준비물: ${r.rec.acc.join(', ')}</div>
        <img src="${src}" alt="${r.date} 코디" loading="lazy"/>
      </div>`;
    }));

    const packingHtml = `<div>${Array.from(pack).join(', ')}</div>`;
    render(summaryHtml, daysHtml.join(''), packingHtml);
    $('status').textContent='완료';
  }catch(e){
    $('status').textContent='실패';
    render(`<span class="err">오류: ${e.message}</span>`, `<div class="muted">실행 가능한 결과가 없습니다.</div>`, `<div class="muted">-</div>`);
  }
}

(function initDates(){
  const s=addDays(new Date(),7), e=addDays(new Date(),11);
  $('start').value=fmtDate(s); $('end').value=fmtDate(e);
})();
$('runBtn').addEventListener('click',run);
</script>
</body>
</html>
