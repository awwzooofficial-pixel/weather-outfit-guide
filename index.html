<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trip Fit Weather</title>
  <meta name="description" content="ì—¬í–‰ ê¸°ê°„ë³„ ë‚ ì”¨ ì˜ˆë³´ì™€ ì„±ë³„/ì—°ë ¹ëŒ€ ë§ì¶¤ ì½”ë””, íŒ¨í‚¹ë¦¬ìŠ¤íŠ¸ë¥¼ í•œ ë²ˆì— ì¶”ì²œí•©ë‹ˆë‹¤." />
  <style>
    :root{
      --bg:#070b14;--bg2:#0d1530;--panel:#0f1a36cc;--line:#2f4375;--text:#f3f6ff;--muted:#9fb3e8;
      --pri:#78a4ff;--pri2:#58dbff;--ok:#8dffca;--warn:#ffd89b;--err:#ffb9b9;
      --shadow:0 12px 40px #00000040;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{
      font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 480px at -15% -10%, #3764ce55 0%, transparent 58%),
        radial-gradient(1000px 450px at 120% 0%, #1da6cf44 0%, transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      min-height:100vh;
    }
    .aurora{
      position:fixed; inset:0; pointer-events:none; opacity:.35;
      background: radial-gradient(700px 260px at 30% 20%, #6ea6ff22, transparent 60%), radial-gradient(600px 220px at 70% 80%, #55f0ff22, transparent 60%);
      filter: blur(24px);
      z-index:0;
    }
    .wrap{max-width:1120px;margin:0 auto;padding:22px;position:relative;z-index:1}
    .panel{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:20px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(8px);
    }
    .hero{display:grid;grid-template-columns:1.2fr .8fr;gap:18px;padding:20px;align-items:stretch}
    .hero h1{margin:0;font-size:36px;line-height:1.08;letter-spacing:.2px}
    .hero p{margin:10px 0 0 0;color:var(--muted)}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);padding:4px 10px;border-radius:999px;font-size:12px;color:#d4e1ff;background:#121e40}
    .hero-visual{
      border:1px solid var(--line);border-radius:16px;padding:12px;
      background:linear-gradient(140deg,#101f42,#122956 45%,#0f3e5b);
      min-height:180px;display:grid;grid-template-columns:repeat(3,1fr);gap:10px;
    }
    .mini{
      border:1px solid #4d639d; border-radius:12px; padding:8px; background:#0f1b3bcc;
      display:flex; flex-direction:column; gap:4px;
    }
    .mini .ic{font-size:18px}
    .mini .tx{font-size:12px;color:#d7e4ff}

    .controls{margin-top:14px;padding:16px}
    .title{font-weight:700;font-size:14px;color:#dbe7ff;margin-bottom:10px}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    input,select,button{
      border-radius:12px;border:1px solid #3f558f;background:#0c1734;color:#fff;padding:11px 12px;font-size:14px;
    }
    input:focus,select:focus{outline:none;border-color:#7ba2ff;box-shadow:0 0 0 3px #6b8fff33}
    button{
      border:none;background:linear-gradient(135deg,var(--pri),var(--pri2));font-weight:800;color:#102245;cursor:pointer;
      box-shadow:0 10px 24px #5f8dff5a;
    }
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px}
    .muted{color:var(--muted);font-size:13px}

    .layout{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}
    .summary,.packing,.days{padding:16px}
    .kpi{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .kpi .badge{background:#0f1b39}

    .day{padding:12px 0;border-bottom:1px dashed #3b518a}
    .day:last-child{border-bottom:none}
    .look{margin-top:8px}
    .look img{width:100%;max-width:260px;border-radius:12px;border:1px solid #3c5288;display:block}

    .empty{color:#b9c8f2;padding:8px 0}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}

    @media (max-width:980px){
      .hero{grid-template-columns:1fr}
      .layout{grid-template-columns:1fr}
    }
    @media (max-width:680px){
      .grid{grid-template-columns:1fr}
      .hero h1{font-size:30px}
      .wrap{padding:14px}
    }
  </style>
</head>
<body>
  <div class="aurora"></div>
  <div class="wrap">

    <section class="panel hero">
      <div>
        <div class="badge">ğŸ§­ Trip Outfit Intelligence Â· v20260218-2</div>
        <h1>ì—¬í–‰ ê¸°ê°„ë³„ ë‚ ì”¨ + ì½”ë”” + íŒ¨í‚¹ë¦¬ìŠ¤íŠ¸</h1>
        <p>ë„ì‹œ/êµ­ê°€, ì¼ì •, ì„±ë³„, ì—°ë ¹ëŒ€ë¥¼ ì…ë ¥í•˜ë©´ ë‚ ì§œë³„ ë‚ ì”¨ì™€ ì‹¤ìš©ì ì¸ ì½”ë””ë¥¼ ìë™ìœ¼ë¡œ ì œì•ˆí•©ë‹ˆë‹¤. ë¨¼ ë¯¸ë˜ ë‚ ì§œëŠ” ê¸°í›„ í‰ê·  fallbackìœ¼ë¡œ ê³„ì‚°í•©ë‹ˆë‹¤.</p>
      </div>
      <div class="hero-visual">
        <div class="mini"><div class="ic">ğŸŒ¤ï¸</div><div class="tx">ì‹¤ì‹œê°„ ì˜ˆë³´</div></div>
        <div class="mini"><div class="ic">ğŸ§¥</div><div class="tx">ë§ì¶¤ ì½”ë””</div></div>
        <div class="mini"><div class="ic">ğŸ§³</div><div class="tx">íŒ¨í‚¹ë¦¬ìŠ¤íŠ¸</div></div>
        <div class="mini"><div class="ic">â˜”</div><div class="tx">ìš°ì‚°/ê°•ìˆ˜ ì•Œë¦¼</div></div>
        <div class="mini"><div class="ic">ğŸ§¢</div><div class="tx">ëª¨ì/ìì™¸ì„ </div></div>
        <div class="mini"><div class="ic">ğŸ“…</div><div class="tx">ê¸°ê°„ë³„ ìµœì í™”</div></div>
      </div>
    </section>

    <section class="panel controls">
      <div class="title">ì—¬í–‰ ì¡°ê±´ ì…ë ¥</div>
      <div class="grid">
        <input id="city" placeholder="ë„ì‹œ (ì˜ˆ: Bangkok, New York, Seoul)" value="Bangkok" />
        <input id="country" placeholder="êµ­ê°€ì½”ë“œ (ì˜ˆ: TH, US, KR)" value="TH" />
        <select id="gender"><option>ë‚¨ì„±</option><option>ì—¬ì„±</option><option>ì¤‘ë¦½</option></select>
        <select id="age">
          <option>10ëŒ€</option><option selected>20ëŒ€</option><option>30ëŒ€</option><option>40ëŒ€</option><option>50ëŒ€</option><option>60ëŒ€</option><option>70ëŒ€</option>
        </select>
        <input id="start" type="date" />
        <input id="end" type="date" />
      </div>
      <div class="row">
        <button id="runBtn">ì¶”ì²œ ë°›ê¸°</button>
        <span id="status" class="muted">ëŒ€ê¸°ì¤‘</span>
      </div>
      <div class="muted">ì˜ˆë³´ ë²”ìœ„ë¥¼ ë„˜ëŠ” ë¯¸ë˜ ë‚ ì§œëŠ” ê³¼ê±° 5ë…„ ë™ì¼ ì›”ì¼ í‰ê· (ê¸°í›„ fallback)ìœ¼ë¡œ ì¶”ì²œí•©ë‹ˆë‹¤.</div>
    </section>

    <section class="layout">
      <div class="panel summary" id="summary">ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
      <div class="panel packing" id="packing"><div class="title">íŒ¨í‚¹ë¦¬ìŠ¤íŠ¸</div><div class="empty">ì—¬í–‰ ì¡°ê±´ ì…ë ¥ í›„ ìƒì„±ë©ë‹ˆë‹¤.</div></div>
    </section>

    <section class="panel days" id="days">
      <div class="title">ë‚ ì§œë³„ ì½”ë””</div>
      <div class="empty">ì¶”ì²œì„ ì‹¤í–‰í•˜ë©´ ë‚ ì§œë³„ ì¹´ë“œê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
    </section>

  </div>

<script>
const $ = (id)=>document.getElementById(id);
const WORKER_API_BASE = 'https://weather-outfit-api.awwzooofficial.workers.dev';
const IMAGE_MODEL = 'qwen/qwen-image';

function stockOutfitImage(meta){
  const hot = meta.tmax >= 28;
  const warm = meta.tmax >= 20 && meta.tmax < 28;
  const rainy = meta.rainProb >= 50;
  const female = meta.gender === 'ì—¬ì„±';

  if (rainy && female) return 'https://images.unsplash.com/photo-1515886657613-9f3515b0c78f?auto=format&fit=crop&w=900&q=80';
  if (rainy && !female) return 'https://images.unsplash.com/photo-1521572267360-ee0c2909d518?auto=format&fit=crop&w=900&q=80';
  if (hot && female) return 'https://images.unsplash.com/photo-1529139574466-a303027c1d8b?auto=format&fit=crop&w=900&q=80';
  if (hot && !female) return 'https://images.unsplash.com/photo-1503342217505-b0a15ec3261c?auto=format&fit=crop&w=900&q=80';
  if (warm && female) return 'https://images.unsplash.com/photo-1483985988355-763728e1935b?auto=format&fit=crop&w=900&q=80';
  if (warm && !female) return 'https://images.unsplash.com/photo-1490578474895-699cd4e2cf59?auto=format&fit=crop&w=900&q=80';
  if (female) return 'https://images.unsplash.com/photo-1541101767792-f9b2b1c4f127?auto=format&fit=crop&w=900&q=80';
  return 'https://images.unsplash.com/photo-1519085360753-af0119f7cbe7?auto=format&fit=crop&w=900&q=80';
}

function fmtDate(d){ return d.toISOString().slice(0,10); }
function addDays(date,n){ const d=new Date(date); d.setDate(d.getDate()+n); return d; }
function dateRange(start,end){ const out=[]; let d=new Date(start); while(d<=end){ out.push(new Date(d)); d=addDays(d,1);} return out; }
function monthDay(s){ return s.slice(5,10); }

function badge(source){ return source==='forecast' ? 'ì‹¤ì‹œê°„ ì˜ˆë³´' : 'ê¸°í›„ í‰ê· '; }

function outfitRule(tMax,tMin,rainProb,gender,age){
  const avg=(tMax+tMin)/2;
  let top='ê¸´íŒ”'; let bottom='ê¸´ë°”ì§€'; let outer='ê°€ë²¼ìš´ ì•„ìš°í„°';
  if(avg>=30){ top='í†µí’ ë°˜íŒ”'; bottom='ë°˜ë°”ì§€/ì–‡ì€ ë°”ì§€'; outer='ì—†ìŒ'; }
  else if(avg>=25){ top='ë°˜íŒ”'; bottom='ì–‡ì€ ê¸´ë°”ì§€'; outer='ì–‡ì€ ê°€ë””ê±´(ì‹¤ë‚´)'; }
  else if(avg>=20){ top='ê¸´íŒ”/ì…”ì¸ '; bottom='ê¸´ë°”ì§€'; outer='ì–‡ì€ ìì¼“'; }
  else if(avg>=14){ top='ê¸´íŒ”+ì´ë„ˆ'; bottom='ê¸´ë°”ì§€'; outer='ìì¼“'; }
  else { top='ë‹ˆíŠ¸/í›„ë””'; bottom='ë‘ê»˜ê° ë°”ì§€'; outer='ì½”íŠ¸/íŒ¨ë”©'; }

  const acc=[];
  if(rainProb>=50) acc.push('ìš°ì‚°');
  if(tMax>=30) acc.push('ëª¨ì/ì„ ê¸€ë¼ìŠ¤');
  if(tMin<=10) acc.push('ë³´ì˜¨ ë¨¸í”ŒëŸ¬');
  acc.push('í¸í•œ ìš´ë™í™”');

  let fit='í™œë™ì„± ìš°ì„ ';
  if(['10ëŒ€','20ëŒ€'].includes(age)) fit='í™œë™ì„± + íŠ¸ë Œë””';
  else if(['50ëŒ€','60ëŒ€','70ëŒ€'].includes(age)) fit='í¸ì•ˆí•¨ + ì²´ì˜¨ìœ ì§€';

  let g='ì¤‘ë¦½ ìŠ¤íƒ€ì¼';
  if(gender==='ë‚¨ì„±') g='ë‚¨ì„± ì‹¤ë£¨ì—£ ê¸°ì¤€';
  else if(gender==='ì—¬ì„±') g='ì—¬ì„± ì‹¤ë£¨ì—£ ê¸°ì¤€';

  return {top,bottom,outer,acc,fit,g};
}

async function geocode(city,country){
  const q = encodeURIComponent(city);
  const c = (country||'').trim().toUpperCase();
  const cc = c ? `&countryCode=${encodeURIComponent(c)}` : '';
  const url=`https://geocoding-api.open-meteo.com/v1/search?name=${q}${cc}&count=10&language=ko&format=json`;
  const r=await fetch(url); if(!r.ok) throw new Error('ë„ì‹œ ê²€ìƒ‰ ì‹¤íŒ¨');
  const j=await r.json();
  if(!j.results || !j.results.length) throw new Error('ë„ì‹œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤');
  return j.results[0];
}

async function forecast(lat,lon,start,end){
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`+
    `&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max,precipitation_sum`+
    `&timezone=auto&start_date=${start}&end_date=${end}`;
  const r=await fetch(url); if(!r.ok) throw new Error('ì˜ˆë³´ ì¡°íšŒ ì‹¤íŒ¨');
  return r.json();
}

async function historicalFallback(lat,lon,start,end){
  const s=new Date(start), e=new Date(end);
  const ys=s.getFullYear()-5, ye=e.getFullYear()-1;
  const url=`https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}`+
    `&start_date=${ys}-01-01&end_date=${ye}-12-31`+
    `&daily=temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=auto`;
  const r=await fetch(url); if(!r.ok) throw new Error('ê¸°í›„ fallback ì¡°íšŒ ì‹¤íŒ¨');
  const j=await r.json();
  const map={};
  const t=j.daily.time||[];
  for(let i=0;i<t.length;i++){
    const md=monthDay(t[i]);
    if(!map[md]) map[md]={n:0,max:0,min:0,pr:0};
    map[md].n++;
    map[md].max += (j.daily.temperature_2m_max?.[i] ?? 0);
    map[md].min += (j.daily.temperature_2m_min?.[i] ?? 0);
    map[md].pr  += (j.daily.precipitation_sum?.[i] ?? 0);
  }
  return map;
}

async function generateOutfitImage(prompt, meta){
  // 1) Try worker image generation (best case)
  try {
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), 5000);
    const r = await fetch(`${WORKER_API_BASE}/api/generate-outfit-image`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ prompt, model: IMAGE_MODEL }),
      signal: ctrl.signal
    });
    clearTimeout(t);

    const j = await r.json();
    const b64 = j?.data?.[0]?.b64_json;
    const url = j?.data?.[0]?.url;
    if (b64) return `data:image/png;base64,${b64}`;
    if (url) return url;
  } catch (_) {}

  // 2) Stable fallback (always show useful outfit image)
  return stockOutfitImage(meta);
}

function render(summaryHtml, daysHtml, packingHtml){
  $('summary').innerHTML = summaryHtml;
  $('days').innerHTML = `<div class="title">ë‚ ì§œë³„ ì½”ë””</div>${daysHtml}`;
  $('packing').innerHTML = `<div class="title">íŒ¨í‚¹ë¦¬ìŠ¤íŠ¸</div>${packingHtml}`;
}

async function renderOutfitImages(rows, city, country, gender, age){
  for (let i=0; i<rows.length; i++){
    const box = document.getElementById(`look-${i}`);
    if (!box) continue;
    box.innerHTML = `<span class="muted">ì´ë¯¸ì§€ ìƒì„±ì¤‘...</span>`;
    try{
      const r = rows[i];
      const prompt = `K-fashion travel outfit photo, exactly one person, ${gender}, ${age}, full body from head to shoes, standing pose, realistic photography, clean background. Weather context: city=${city}, country=${country}, low=${r.tmin.toFixed(1)}C, high=${r.tmax.toFixed(1)}C, rain=${Math.round(r.rainProb)}%. Required clothes: ${r.rec.top}, ${r.rec.bottom}, ${r.rec.outer}. Avoid: text, logo, watermark, extra people, extra limbs, blur, cartoon.`;
      const src = await generateOutfitImage(prompt, { tmax: r.tmax, rainProb: r.rainProb, gender });
      box.innerHTML = `<div class="look"><img src="${src}" alt="${r.date} ì½”ë””" loading="lazy"/></div>`;
    }catch(e){
      const fb = stockOutfitImage({ tmax: r.tmax, rainProb: r.rainProb, gender });
      box.innerHTML = `<div class="look"><img src="${fb}" alt="${r.date} ì½”ë””" loading="lazy"/></div>`;
    }
  }
}

async function run(){
  try{
    $('status').textContent='ì¡°íšŒì¤‘...';
    const city=$('city').value.trim();
    const country=$('country').value.trim();
    const gender=$('gender').value;
    const age=$('age').value;
    const start=$('start').value; const end=$('end').value;
    if(!city||!start||!end) throw new Error('ë„ì‹œ/ê¸°ê°„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
    if(start>end) throw new Error('ì¢…ë£Œì¼ì´ ì‹œì‘ì¼ë³´ë‹¤ ë¹ ë¦…ë‹ˆë‹¤.');

    const loc=await geocode(city,country);
    const today=fmtDate(new Date());
    const maxForecastDate=fmtDate(addDays(new Date(),15));
    const tripDates=dateRange(new Date(start),new Date(end)).map(fmtDate);

    const needFallback = tripDates.some(d=>d>maxForecastDate);
    const forecastEnd = tripDates.filter(d=>d<=maxForecastDate).slice(-1)[0] || today;

    let fData={daily:{time:[],temperature_2m_max:[],temperature_2m_min:[],precipitation_probability_max:[],precipitation_sum:[]}};
    if(start<=forecastEnd){ fData=await forecast(loc.latitude,loc.longitude,start,forecastEnd); }
    const fMap={};
    (fData.daily.time||[]).forEach((d,i)=>{
      fMap[d]={source:'forecast',tmax:fData.daily.temperature_2m_max?.[i],tmin:fData.daily.temperature_2m_min?.[i],rainProb:fData.daily.precipitation_probability_max?.[i] ?? 0,rainMm:fData.daily.precipitation_sum?.[i] ?? 0};
    });

    let climate=null;
    if(needFallback){ climate=await historicalFallback(loc.latitude,loc.longitude,start,end); }

    const rows=[]; const pack=new Set();
    for(const d of tripDates){
      let it=fMap[d];
      if(!it){
        const md=monthDay(d); const c=climate?.[md];
        if(c && c.n>0){ it={source:'climate',tmax:c.max/c.n,tmin:c.min/c.n,rainProb:Math.min(100,Math.round((c.pr/c.n)*20)),rainMm:c.pr/c.n}; }
        else { it={source:'climate',tmax:24,tmin:18,rainProb:30,rainMm:1}; }
      }
      const rec=outfitRule(it.tmax,it.tmin,it.rainProb,gender,age);
      rec.acc.forEach(x=>pack.add(x));
      rows.push({date:d,...it,rec});
    }

    const summaryHtml = `
      <div><b>${loc.name}</b>, ${loc.country} <span class="muted">(${loc.latitude.toFixed(2)}, ${loc.longitude.toFixed(2)})</span></div>
      <div class="muted" style="margin-top:6px">${start} ~ ${end} Â· ${gender} / ${age}</div>
      <div class="kpi">
        <span class="badge">ì˜ˆë³´ ê¸°ë°˜ ${rows.filter(r=>r.source==='forecast').length}ì¼</span>
        <span class="badge">ê¸°í›„ fallback ${rows.filter(r=>r.source==='climate').length}ì¼</span>
      </div>`;

    const daysHtml = rows.map((r,idx)=>`
      <div class="day">
        <div><b>${r.date}</b> <span class="badge">${badge(r.source)}</span></div>
        <div class="muted">ìµœì €/ìµœê³  ${r.tmin.toFixed(1)}Â°C / ${r.tmax.toFixed(1)}Â°C Â· ê°•ìˆ˜í™•ë¥  ${Math.round(r.rainProb)}% Â· ê°•ìˆ˜ëŸ‰ ${r.rainMm.toFixed(1)}mm</div>
        <div style="margin-top:6px">ì½”ë”” (${r.rec.g}): <b>${r.rec.top}</b> + <b>${r.rec.bottom}</b> + <b>${r.rec.outer}</b></div>
        <div class="muted">ìŠ¤íƒ€ì¼ ê°€ì¤‘ì¹˜: ${r.rec.fit}</div>
        <div>ì¤€ë¹„ë¬¼: ${r.rec.acc.join(', ')}</div>
        <div id="look-${idx}"></div>
      </div>`).join('');

    const packingHtml = `<div>${Array.from(pack).join(', ')}</div>`;

    render(summaryHtml, daysHtml, packingHtml);
    $('status').textContent='ì™„ë£Œ (ì´ë¯¸ì§€ ìƒì„±ì¤‘)';
    await renderOutfitImages(rows, loc.name, loc.country, gender, age);
    $('status').textContent='ì™„ë£Œ';
  }catch(e){
    $('status').textContent='ì‹¤íŒ¨';
    render(`<span class="err">ì˜¤ë¥˜: ${e.message}</span>`, `<div class="empty">ì‹¤í–‰ ê°€ëŠ¥í•œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`, `<div class="empty">-</div>`);
  }
}

(function initDates(){
  const s=addDays(new Date(),7), e=addDays(new Date(),11);
  $('start').value=fmtDate(s); $('end').value=fmtDate(e);
})();
$('runBtn').addEventListener('click',run);
</script>
</body>
</html>
